<div class="content-body">
  <div class="content_1">
    <h3>Emergency Request History</h3>
    <p>List of past emergency requests</p>

    <div class="search-bar">
      <input
        type="text"
        placeholder="Search requests..."
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
      />
      <button><i class="bx bx-search"></i></button>
      <div class="report-button">
        <button (click)="generateReport()">
          <i class="bx bx-file"></i> Generate Report
        </button>
      </div>
    </div>

    <!-- Bar Chart Only -->
    <div class="chart-wrapper full-width">
      <canvas #requestStatusBarChart></canvas>
      <p class="chart-label">Monthly Requests by Event</p>
    </div>
    <br />

    <!-- Top Action Bar -->
    <div class="top-action-bar" *ngIf="selectedRequests.length > 0">
      <span>{{ selectedRequests.length }} selected</span>
      <button (click)="deleteSelectedRequests()">
        <i class="bx bx-trash"></i> Delete
      </button>
    </div>

    <!-- Request Cards -->
    <div class="request-list-container">
      <h4>All Resolve Request</h4>
      <p>List of emergency requests</p>
      <div
        *ngFor="let req of getCurrentFilteredRequests()"
        class="request-card"
      >
        <div class="request-header">
          <div class="user-info">
            <img [src]="req.profilePicture || defaultAvatar" alt="User" />
            <div class="user-details">
              <h5>{{ req.name || "Unknown User" }}</h5>
              <p><i class="bx bxs-phone"></i> {{ req.contactNumber || "-" }}</p>
            </div>
          </div>
          <span
            class="status-badge"
            [ngClass]="{
              resolved:
                req.status.toLowerCase() === 'completed' ||
                req.status.toLowerCase() === 'resolved',
              cancelled: req.status.toLowerCase() === 'cancelled',
            }"
          >
            {{ req.status | titlecase }}
          </span>
        </div>

        <div class="request-body">
          <p>
            <i class="bx bx-time"></i>
            {{ req.timestamp?.toDate() | date: "medium" }}
          </p>
          <p><i class="bx bxs-location-plus"></i> {{ req.address || "-" }}</p>
          <p><strong>Event:</strong> {{ req.event || "-" }}</p>
          <p><strong>Accepted By:</strong> {{ req.staffFullName || "-" }}</p>
        </div>

        <div class="request-footer">
          <span
            class="view clickable"
            (click)="viewRequest(req)"
            [routerLink]="['/admin/EmergencyRequest', req.id]"
            [queryParams]="{ from: 'emergency' }"
          >
            <i class="bx bx-show"></i> View
          </span>
        </div>
      </div>
    </div>

    <!-- No Data -->
    <ng-template #noDataTemplate>
      <div class="no-data">
        <img src="assets/Empty Box.gif" alt="No Data" />
        <p>No requests available.</p>
      </div>
    </ng-template>
  </div>
</div>

<div class="loading-modal-backdrop" *ngIf="blockingInProgress">
  <div class="loading-modal-content">
    <div class="spinner"></div>
    <div>Generating report, please wait...</div>
  </div>
</div>
