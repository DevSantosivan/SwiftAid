<div class="content-body">
  <div style="background-color: #fff; padding: 20px" class="content_1">
    <h4>Emergency Request History</h4>
    <p>List of past emergency requests</p>

    <!-- Search Bar with Icon -->
    <!-- Filter Controls Container -->
    <div
      class="filters-container"
      style="
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
      "
    >
      <!-- Search Bar -->
      <div
        class="search-bar"
        style="
          display: flex;
          align-items: center;
          gap: 10px;
          flex-grow: 1;
          min-width: 250px;
        "
      >
        <i class="bx bx-search" style="font-size: 22px; color: #888"></i>
        <input
          type="text"
          placeholder="Search requests..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          style="
            padding: 8px;
            width: 100%;
            max-width: 300px;
            border-radius: 5px;
          "
        />
      </div>

      <!-- Date Range Filters -->

      <!-- Export Buttons -->
      <div style="display: flex">
        <div class="date-filters">
          <label for="startDate">From Date </label>
          <input
            id="startDate"
            type="date"
            [(ngModel)]="filterStartDate"
            (change)="onDateFilterChange()"
            style="padding: 6px; border-radius: 4px; border: 1px solid #ccc"
          />

          <label for="endDate">To Date</label>
          <input
            id="endDate"
            type="date"
            [(ngModel)]="filterEndDate"
            (change)="onDateFilterChange()"
            style="padding: 6px; border-radius: 4px; border: 1px solid #ccc"
          />
        </div>
        <div class="export-buttons" style="margin: 0px 20px">
          <button
            (click)="exportToWord()"
            type="button"
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              border: 1px solid #ccc;
            "
          >
            <i class="bx bxs-file-doc"></i> Export to Word
          </button>
          <button
            (click)="exportToExcel()"
            type="button"
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              border: 1px solid #ccc;
            "
          >
            <i class="bx bx-table"></i> Export to Excel
          </button>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div
      id="incidentMap"
      style="border-radius: 10px; height: 400px; border: 1px solid #ccc"
    ></div>

    <!-- Date Range Filters -->

    <!-- Request List or No Data -->
    <div *ngIf="pagedRequests && pagedRequests.length > 0; else noDataTemplate">
      <ng-container
        *ngTemplateOutlet="requestListTemplate; context: { requests: pagedRequests }"
      >
      </ng-container>
    </div>

    <!-- No Data Template -->
    <ng-template #noDataTemplate>
      <div class="no-data">
        <img src="assets/Empty Box.gif" alt="No Data" />
        <p>No requests available.</p>
      </div>
    </ng-template>

    <!-- Pagination Controls -->
    <div
      class="pagination-container"
      style="
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      "
    >
      <span>Page {{ currentPage }} of {{ totalPages }}</span>

      <div
        class="pagination-buttons"
        style="display: flex; gap: 10px"
        *ngIf="totalPages > 4"
      >
        <button
          style="border: none; color: red"
          (click)="goToPreviousPage()"
          [disabled]="currentPage === 1"
        >
          ← Previous
        </button>
        <button
          style="border: none; color: red"
          (click)="goToNextPage()"
          [disabled]="currentPage === totalPages"
        >
          Next →
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Request List Template -->
<!-- Request List Template -->
<ng-template #requestListTemplate let-requests="requests">
  <br />

  <!-- Header -->
  <div
    class="account-header"
    style="
      display: flex;
      font-weight: bold;
      padding: 10px 14px;
      background-color: #fafafa;
      border-bottom: 2px solid #e0e0e0;
    "
  >
    <span style="flex: 2; display: flex; align-items: center">
      <i class="bx bx-user" style="margin-right: 6px"></i>Resident
    </span>
    <span style="flex: 1; display: flex; align-items: center">
      <i class="bx bxs-ambulance" style="margin-right: 6px"></i>Type Of Incident
    </span>
    <span style="flex: 1; display: flex; align-items: center">
      <i class="bx bx-check-circle" style="margin-right: 6px"></i>Status
    </span>
    <span style="flex: 2; display: flex; align-items: center">
      <i class="bx bxs-location-plus" style="margin-right: 6px"></i>Location
    </span>
    <span style="flex: 1; display: flex; align-items: center">
      <i class="bx bx-time" style="margin-right: 6px"></i>Time
    </span>
    <span style="flex: 0.8; text-align: center">Actions</span>
  </div>

  <!-- Rows -->
  <div class="account-list">
    <div
      class="account-row"
      *ngFor="let req of requests "
      (mouseenter)="onRequestHover(req)"
      style="
        display: flex;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid #eee;
      "
    >
      <!-- Resident -->
      <span style="flex: 2; display: flex; align-items: center; gap: 10px">
        <img
          [src]="req.profilePicture || 'assets/profile-deafault.jpg'"
          alt="Resident image"
          style="
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
          "
        />
        <div>
          <div style="font-weight: 500">{{ req.name }}</div>
          <div style="font-size: 12px; color: #666">
            <i class="bx bx-phone" style="font-size: 14px"></i>
            {{ req.contactNumber }}
          </div>
        </div>
      </span>

      <!-- Incident -->
      <span style="flex: 1">{{ req.event || '-' }}</span>

      <!-- Status -->
      <span style="flex: 1; display: flex; flex-direction: column">
        <span
          class="status-badge"
          [ngClass]="{
            pending: req.status.toLowerCase() === 'pending',
            accepted: req.status.toLowerCase() === 'accepted' || req.status.toLowerCase() === 'responding',
            completed: req.status.toLowerCase() === 'completed' || req.status.toLowerCase() === 'resolved',
            cancelled: req.status.toLowerCase() === 'cancelled'
          }"
        >
          {{ req.status === 'responding' ? 'In Progress' : (req.status |
          titlecase) }}
        </span>
        <span> {{req.staffUpdatedAt?.toDate() | date: 'medium'}}</span>
      </span>

      <!-- Location -->
      <span style="flex: 2">
        <a
          [href]="'https://www.google.com/maps?q=' + req.latitude + ',' + req.longitude"
          target="_blank"
          style="color: #1976d2; text-decoration: none"
          >{{ req.address || '-' }}</a
        >
      </span>

      <!-- Time -->
      <span style="flex: 1">
        {{ req.timestamp?.toDate() | date: 'medium' }}
      </span>

      <!-- Actions -->
      <span style="flex: 0.8; text-align: center">
        <button
          class="view-btn"
          [routerLink]="['/superAdmin', 'IncidentHistory', req.id]"
          [queryParams]="{ from: 'incident' }"
        >
          <i class="bx bx-show"></i> View Details
        </button>
      </span>
    </div>
  </div>
</ng-template>
