<div class="content-body">
  <div class="content_1">
    <h4>Emergency Request History</h4>
    <p>List of past emergency requests</p>

    <!-- Bulk Select Dropdown (commented out) -->
    <!--
    <div class="bulk-select-dropdown">
      <input
        type="checkbox"
        [checked]="isAllSelected()"
        (change)="toggleSelectAllRequests($event)"
      />
      <div class="dropdown">
        <button class="dropdown-toggle" (click)="toggleBulkMenu($event)">
          ▾
        </button>
        <div class="dropdown-list" *ngIf="showBulkMenu">
          <button (click)="selectBy('all')">Select All</button>
          <button (click)="selectBy('none')">Select None</button>
          <button (click)="selectBy('accepted')">Accepted by Me</button>
          <button (click)="selectBy('completed')">Completed</button>
        </div>
      </div>
    </div>
    -->

    <!-- Search Bar -->
    <div class="flex-header">
      <div class="export-section">
        <div class="export-buttons">
          <button (click)="exportToWord()" type="button">
            <i class="bx bxs-file-doc"></i>
            Export to Word
          </button>
          <button (click)="exportToExcel()" type="button">
            <i class="bx bx-table"></i>
            Export to Excel
          </button>
        </div>
      </div>
      <div class="search-bar">
        <input
          type="text"
          placeholder="Search requests..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        />
        <button type="button"><i class="bx bx-search"></i></button>
      </div>
    </div>

    <!-- Map Container: Show only if requestToView has latitude & longitude -->
    <div
      id="incidentMap"
      style="border-radius: 10px; height: 400px; border: 1px solid #ccc"
    ></div>
    <!-- Request List or No Data -->
    <div
      *ngIf="filteredAllRequests && filteredAllRequests.length > 0; else noDataTemplate"
    >
      <ng-container
        *ngTemplateOutlet="requestListTemplate; context: { requests: filteredAllRequests }"
      >
      </ng-container>
    </div>

    <!-- No Data Template -->
    <ng-template #noDataTemplate>
      <div class="no-data">
        <img src="assets/Empty Box.gif" alt="No Data" />
        <p>No requests available.</p>
      </div>
    </ng-template>
  </div>
</div>
<br />
<!-- Request List Template -->
<ng-template #requestListTemplate let-requests="requests">
  <br />
  <div class="account-header">
    <span class="col-requester">Requester</span>
    <span class="col-type">Type</span>
    <span class="col-address">Address</span>
    <span class="col-date">Date</span>
    <span class="col-status">Status</span>
    <span class="col-staff">Staff</span>
    <span class="col-action">Action</span>
  </div>

  <div class="account-list">
    <div
      class="account-row"
      *ngFor="let req of requests"
      (mouseenter)="onRequestHover(req)"
      (mouseleave)="onRequestHoverOut()"
      (click)="$event.stopPropagation()"
    >
      <td class="requester-cell">
        <div class="requester-content">
          <img
            [src]="req.image || 'assets/default-marker-icon.png'"
            alt="Requester image"
          />
          <div class="requester-text">
            <div class="requester-name">{{ req.name }}</div>
            <div class="requester-contact">{{ req.contactNumber }}</div>
          </div>
        </div>
      </td>

      <span class="col-type">{{ req.event || '-' }}</span>
      <span class="col-address">{{ req.address || '-' }}</span>
      <span class="col-date">
        {{ req.timestamp?.toDate() | date: 'mediumDate' }}
      </span>

      <span
        class="col-status"
        [ngClass]="{
          pending: req.status.toLowerCase() === 'pending',
          accepted: req.status.toLowerCase() === 'accepted' || req.status.toLowerCase() === 'responding',
          completed: req.status.toLowerCase() === 'completed' || req.status.toLowerCase() === 'resolved',
          cancelled: req.status.toLowerCase() === 'cancelled'
        }"
      >
        {{ req.status === 'responding' ? 'In Progress' : (req.status |
        titlecase) }}
      </span>

      <span class="col-staff">{{ req.staffFullName || '-' }}</span>

      <!-- ✅ Moved checkbox and action button to last column -->
      <span class="col-action action-buttons">
        <button
          title="View"
          [routerLink]="['/superAdmin', 'IncidentHistory', req.id]"
          [queryParams]="{ from: 'incident' }"
        >
          <i class="bx bx-show"></i>
        </button>
      </span>
    </div>
  </div>
</ng-template>

<!-- View Request Modal -->
<div class="isProfilemodal" *ngIf="requestToView">
  <div class="modal-content view-member-modal">
    <span class="close" (click)="closeView()">&times;</span>
    <h3>Request Details</h3>
    <div>
      <p><strong>Request ID:</strong> {{ requestToView.id }}</p>
      <p>
        <strong>Date:</strong>
        {{ requestToView.timestamp?.toDate() | date : 'fullDate' }}
      </p>
      <p><strong>Status:</strong> {{ requestToView.status | titlecase }}</p>
      <p><strong>Event Incident:</strong> {{ requestToView.event }}</p>
      <p>
        <strong>Accepted By:</strong> {{ requestToView.staffFullName || '-' }}
      </p>
      <p><strong>Description:</strong> {{ requestToView.description }}</p>
    </div>
  </div>
</div>
